<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lurkout · Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
    <style>
        :root{--bg:#060608;--panel:#0f1012;--muted:#9aa4b2;--accent:#ff2d55;--glass:rgba(255,255,255,0.03)}
        *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
        body{margin:0;background:linear-gradient(180deg,#050608 0%, #0b0d10 100%);color:#e6eef8;min-height:100vh}
        .wrap{max-width:1100px;margin:28px auto;padding:18px}
        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        h1{font-weight:700;letter-spacing:1px}
        .muted{color:var(--muted)}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:16px;border-radius:12px}
        .btn{background:linear-gradient(90deg,var(--accent),#b91c38);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
        .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
        .row{display:flex;gap:8px}
        input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
        .center{display:flex;align-items:center;justify-content:center}
        .hidden{display:none}
        pre.code{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;max-height:260px;overflow:auto}
        footer{text-align:center;margin-top:18px;color:var(--muted)}
        .loginCard{max-width:480px;margin:40px auto;padding:22px;border-radius:14px}
        .logo{display:flex;gap:10px;align-items:center}
        .logo .dot{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#b91c38);box-shadow:0 6px 20px rgba(255,45,85,0.12)}
        .menu{background:var(--panel);border-radius:10px;padding:4px;margin-bottom:20px}
        .menu-list{display:flex;gap:4px;list-style:none;padding:0;margin:0}
        .menu-item{padding:8px 16px;border-radius:8px;cursor:pointer;transition:background 0.2s}
        .menu-item:hover{background:rgba(255,255,255,0.05)}
        .menu-item.active{background:var(--accent)}
        .section{display:none}
        .section.active{display:block}
        .checkpoint-list{list-style:none;padding:0;margin:0}
        .checkpoint-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04)}
        .checkpoint-status{margin-right:12px;font-size:20px}
        .checkpoint-content{flex:1}
        .checkpoint-title{margin:0 0 4px;font-size:16px}
        .checkpoint-url{font-size:14px;color:var(--muted);word-break:break-all}
        .checkpoint-actions{margin-left:12px;opacity:0;transition:opacity 0.2s}
        .checkpoint-item:hover .checkpoint-actions{opacity:1}
        .provider-badge{padding:2px 6px;border-radius:4px;font-size:12px;background:rgba(255,255,255,0.1);margin-right:8px}
        .user-menu{position:relative}
        .user-dropdown{position:absolute;top:100%;right:0;background:var(--panel);border-radius:8px;padding:8px;min-width:200px;margin-top:8px;border:1px solid rgba(255,255,255,0.04);display:none}
        .user-menu:hover .user-dropdown{display:block}
        .user-dropdown-item{padding:8px 12px;cursor:pointer;border-radius:4px}
        .user-dropdown-item:hover{background:rgba(255,255,255,0.05)}
        .completion-url{background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.2);padding:12px;border-radius:8px;word-break:break-all;margin-top:12px}
        .loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
        .loading::after{content:'';width:40px;height:40px;border:3px solid var(--accent);border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="loading" class="loading hidden"></div>
    <div class="wrap">
        <header>
            <div class="logo">
                <div class="dot"></div>
                <h1>Lurkout</h1>
            </div>
            <div id="userArea" class="user-menu">
                <div id="userInfo"></div>
                <div class="user-dropdown">
                    <div class="user-dropdown-item" id="btnLogout">Logout</div>
                </div>
            </div>
        </header>

        <main id="mainArea">
            <!-- Login screen -->
            <section id="loginScreen" class="card loginCard center">
                <div style="width:100%">
                    <h2>Sign in to Lurkout</h2>
                    <p class="muted">Use Discord to sign in and access the dashboard.</p>
                    <div class="row" style="margin-top:12px">
                        <button id="btnLogin" class="btn">Sign in with Discord</button>
                    </div>
                </div>
            </section>

            <!-- Dashboard -->
            <section id="dashboard" class="hidden">
                <nav class="menu">
                    <ul class="menu-list">
                        <li class="menu-item active" data-section="checkpoints">Checkpoints</li>
                        <li class="menu-item" data-section="scripts">Scripts</li>
                    </ul>
                </nav>

                <div id="checkpointsSection" class="section active">
                    <div class="grid">
                        <div>
                            <div class="card">
                                <h3>Your Checkpoints</h3>
                                <div class="checkpoint-list" id="checkpointList"></div>
                                <button id="addCheckpoint" class="btn" style="width:100%;margin-top:12px">
                                    + Add New Checkpoint
                                </button>
                                <div id="completionUrl" class="completion-url hidden"></div>
                            </div>
                        </div>
                        <div>
                            <div class="card">
                                <h3>Recent Activity</h3>
                                <div id="activityLog" class="muted">
                                    No recent activity
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scriptsSection" class="section">
                    <div class="grid">
                        <div>
                            <div class="card">
                                <h3>Generate Script</h3>
                                <label class="muted small">Script Title</label>
                                <input id="scriptTitle" placeholder="My Awesome Script">
                                <label class="muted small" style="margin-top:12px">Webhook URL (Optional)</label>
                                <input id="webhookUrl" placeholder="https://discord.com/api/webhooks/...">
                                <div class="row" style="margin-top:12px">
                                    <button id="generateScript" class="btn">Generate</button>
                                    <button id="downloadScript" class="btn ghost hidden">Download</button>
                                </div>
                                <pre id="scriptPreview" class="code hidden"></pre>
                            </div>
                        </div>
                        <div>
                            <div class="card">
                                <h3>Your Scripts</h3>
                                <div id="scriptsList" class="muted">
                                    No scripts generated yet
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="muted">Lurkout · Luarmor Clone</footer>
    </div>

    <!-- Add Checkpoint Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h3>Add Checkpoint</h3>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="newCheckpointTitle">
            </div>
            <div class="form-group">
                <label>URL</label>
                <input type="url" id="newCheckpointUrl">
            </div>
            <div class="form-group">
                <label>Provider</label>
                <select id="newCheckpointProvider">
                    <option value="linkvertise">Linkvertise</option>
                    <option value="workink">Work.ink</option>
                    <option value="lootlabs">LootLabs</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn ghost" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="saveCheckpoint()">Add</button>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const DISCORD_CLIENT_ID = '1432798922757115985';
        const DISCORD_REDIRECT_URI = window.location.origin;
        const DISCORD_SCOPE = 'identify guilds guilds.join guilds.members.read';
        const REQUIRED_SERVER_ID = '1431480103686246420';
        const REQUIRED_ROLE_ID = '1433579851259838464';

        // UI Elements
        const loading = document.getElementById('loading');
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const userArea = document.getElementById('userArea');
        const userInfo = document.getElementById('userInfo');

        // Menu navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                // Update menu items
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Show corresponding section
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(`${item.dataset.section}Section`).classList.add('active');
            });
        });

        // Show loading state
        function showLoading(show = true) {
            loading.classList.toggle('hidden', !show);
        }

        // Initialize Appwrite
        async function initializeAppwrite() {
            try {
                showLoading(true);
                const response = await fetch('/config.json');
                const config = await response.json();
                
                const sdk = new Appwrite();
                sdk.setEndpoint('https://cloud.appwrite.io/v1')
                   .setProject(config.APPWRITE_PROJECT_ID)
                   .setKey(config.APPWRITE_API_KEY);
                
                window._lurkoutSDK = sdk;
                window._lurkoutConfig = config;
                
                return sdk;
            } catch (error) {
                console.error('Failed to initialize Appwrite:', error);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // PKCE Code Verifier
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        // PKCE Code Challenge
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Auth State
        function getAuthState() {
            const state = crypto.randomUUID();
            localStorage.setItem('discord_state', state);
            return state;
        }

        function verifyAuthState(returnedState) {
            const savedState = localStorage.getItem('discord_state');
            localStorage.removeItem('discord_state');
            return savedState === returnedState;
        }

        // UI Rendering
        function renderAuth(user) {
            if (user) {
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                userInfo.textContent = user.username;
                userArea.classList.remove('hidden');
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
                userInfo.textContent = '';
                userArea.classList.add('hidden');
            }
        }

        // Handle OAuth callback
        async function handleCallback(code, verifier) {
            try {
                showLoading(true);
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    body: new URLSearchParams({
                        client_id: DISCORD_CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: DISCORD_REDIRECT_URI,
                        code_verifier: verifier
                    }),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                const tokenData = await tokenResponse.json();
                if (!tokenData.access_token) {
                    throw new Error('Failed to get access token');
                }

                // Get user data
                const userResponse = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        Authorization: `Bearer ${tokenData.access_token}`
                    }
                });
                const userData = await userResponse.json();

                // Check guild membership and role
                const guildResponse = await fetch(`https://discord.com/api/users/@me/guilds/${REQUIRED_SERVER_ID}/member`, {
                    headers: {
                        Authorization: `Bearer ${tokenData.access_token}`
                    }
                });
                const guildData = await guildResponse.json();

                if (!guildData.roles?.includes(REQUIRED_ROLE_ID)) {
                    throw new Error('Missing required role');
                }

                // Store session
                const session = {
                    ...userData,
                    accessToken: tokenData.access_token,
                    tokenType: tokenData.token_type
                };
                return session;
            } finally {
                showLoading(false);
            }
        }

        // Login
        btnLogin.onclick = async function() {
            const verifier = generateCodeVerifier();
            const challenge = await generateCodeChallenge(verifier);
            const state = getAuthState();
            
            localStorage.setItem('code_verifier', verifier);
            localStorage.setItem('auth_redirect', window.location.pathname);
            
            const params = new URLSearchParams({
                client_id: DISCORD_CLIENT_ID,
                redirect_uri: DISCORD_REDIRECT_URI,
                response_type: 'code',
                scope: DISCORD_SCOPE,
                code_challenge: challenge,
                code_challenge_method: 'S256',
                state: state
            });

            window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        };

        // Logout
        btnLogout.onclick = function() {
            localStorage.removeItem('lurkout_session');
            localStorage.removeItem('code_verifier');
            localStorage.removeItem('discord_state');
            window.location.href = '/';
        };

        // Initialize
        (async function() {
            try {
                await initializeAppwrite();
                
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const state = params.get('state');
                
                if (code) {
                    // Verify state to prevent CSRF
                    if (!state || !verifyAuthState(state)) {
                        throw new Error('Invalid state parameter');
                    }

                    // Clear URL parameters
                    const currentPath = window.location.pathname;
                    window.history.replaceState({}, '', currentPath);
                    
                    const verifier = localStorage.getItem('code_verifier');
                    if (verifier) {
                        const session = await handleCallback(code, verifier);
                        if (session) {
                            window._lurkoutSession = session;
                            localStorage.setItem('lurkout_session', JSON.stringify(session));
                            
                            // Check if we need to redirect
                            const redirectPath = localStorage.getItem('auth_redirect');
                            if (redirectPath && redirectPath !== '/') {
                                localStorage.removeItem('auth_redirect');
                                window.location.pathname = redirectPath;
                                return;
                            }
                            
                            renderAuth(session);
                            await loadCheckpoints();
                        }
                    }
                } else {
                    const session = JSON.parse(localStorage.getItem('lurkout_session'));
                    if (session) {
                        window._lurkoutSession = session;
                        renderAuth(session);
                        await loadCheckpoints();
                    } else if (window.location.pathname !== '/') {
                        // Store current path for post-login redirect
                        localStorage.setItem('auth_redirect', window.location.pathname);
                        window.location.href = '/';
                    }
                }
            } catch (error) {
                console.error('Initialization error:', error);
                localStorage.removeItem('lurkout_session');
                localStorage.removeItem('code_verifier');
                localStorage.removeItem('discord_state');
                
                if (window.location.pathname !== '/') {
                    window.location.href = '/';
                } else {
                    renderAuth(null);
                }
            }
        })();
    </script>
</body>
</html>