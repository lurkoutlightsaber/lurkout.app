<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lurkout · Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
    <style>
        :root{--bg:#060608;--panel:#0f1012;--muted:#9aa4b2;--accent:#ff2d55;--glass:rgba(255,255,255,0.03)}
        *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
        body{margin:0;background:linear-gradient(180deg,#050608 0%, #0b0d10 100%);color:#e6eef8;min-height:100vh}
        .wrap{max-width:1100px;margin:28px auto;padding:18px}
        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        h1{font-weight:700;letter-spacing:1px}
        .muted{color:var(--muted)}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:16px;border-radius:12px}
        .btn{background:linear-gradient(90deg,var(--accent),#b91c38);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
        .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
        .row{display:flex;gap:8px}
        input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
        .center{display:flex;align-items:center;justify-content:center}
        .hidden{display:none}
        pre.code{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;max-height:260px;overflow:auto}
        footer{text-align:center;margin-top:18px;color:var(--muted)}
        .loginCard{max-width:480px;margin:40px auto;padding:22px;border-radius:14px}
        .logo{display:flex;gap:10px;align-items:center}
        .logo .dot{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#b91c38);box-shadow:0 6px 20px rgba(255,45,85,0.12)}
        .checkpoint-list{list-style:none;padding:0;margin:0}
        .checkpoint-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px}
        .checkpoint-status{margin-right:12px;font-size:20px}
        .checkpoint-content{flex:1}
        .checkpoint-title{margin:0 0 4px;font-size:16px}
        .checkpoint-url{font-size:14px;color:var(--muted);word-break:break-all}
        .checkpoint-actions{margin-left:12px}
        .provider-icon{width:20px;height:20px;margin-right:8px;vertical-align:middle}
        .add-checkpoint{margin-top:12px;width:100%;padding:12px;border:2px dashed rgba(255,255,255,0.1);border-radius:8px;background:transparent;color:var(--muted);cursor:pointer}
        .add-checkpoint:hover{border-color:var(--accent);color:var(--accent)}
        .completion-url{background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.2);padding:12px;border-radius:8px;word-break:break-all;margin-top:12px}
        .drag-handle{cursor:move;padding:0 8px;color:var(--muted)}
        .checkpoint-item.completed{background:rgba(76,175,80,0.1)}
        .checkpoint-item.completed .checkpoint-status{color:#4CAF50}
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="logo"><div class="dot"></div><h1>Lurkout</h1></div>
            <div id="userArea"></div>
        </header>

        <main id="mainArea">
            <section id="loginScreen" class="card loginCard center">
                <div style="width:100%">
                    <h2>Sign in to Lurkout</h2>
                    <p class="muted">Use Discord to sign in and access the dashboard.</p>
                    <div class="row" style="margin-top:12px">
                        <button id="btnLogin" class="btn">Sign in with Discord</button>
                    </div>
                </div>
            </section>

            <section id="dashboard" class="hidden">
                <div class="grid">
                    <div>
                        <div class="card">
                            <h3>Account</h3>
                            <p id="accountInfo" class="muted">—</p>
                            <div class="row">
                                <button id="btnLogout" class="btn ghost small">Logout</button>
                            </div>
                        </div>

                        <div class="card" style="margin-top:12px">
                            <h3>Checkpoints</h3>
                            <div class="checkpoint-list" id="checkpointList"></div>
                            <button class="add-checkpoint" id="addCheckpoint">+ Add New Checkpoint</button>
                            <div id="completionUrl" class="completion-url hidden"></div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <h3>Script Generator</h3>
                            <label class="muted small">Script title: <input id="scriptTitle"></label>
                            <label class="muted small">Webhook (optional): <input id="webhookUrl"></label>
                            <div class="row" style="margin-top:8px">
                                <button id="generateScript" class="btn small">Generate .lua</button>
                                <button id="downloadLink" class="btn ghost small hidden" download="lurkout.lua">Download</button>
                            </div>
                            <pre id="scriptPreview" class="code"></pre>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="muted">Lurkout · Glassmorphic UI</footer>

        <!-- Add Checkpoint Modal -->
        <div class="modal hidden" id="addCheckpointModal">
            <div class="modal-content">
                <h3>Add Checkpoint</h3>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="newCheckpointTitle">
                </div>
                <div class="form-group">
                    <label>URL</label>
                    <input type="url" id="newCheckpointUrl">
                </div>
                <div class="form-group">
                    <label>Provider</label>
                    <select id="newCheckpointProvider">
                        <option value="linkvertise">Linkvertise</option>
                        <option value="workink">Work.ink</option>
                        <option value="lootlabs">LootLabs</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn ghost" onclick="closeModal()">Cancel</button>
                    <button class="btn" onclick="saveCheckpoint()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const DISCORD_CLIENT_ID = '1432798922757115985';
        const DISCORD_REDIRECT_URI = window.location.origin;
        const DISCORD_SCOPE = 'identify guilds guilds.join guilds.members.read';
        const REQUIRED_SERVER_ID = '1431480103686246420';
        const REQUIRED_ROLE_ID = '1433579851259838464';

        // Initialize Appwrite (configured via GitHub Actions from repository secrets)
        async function initializeAppwrite() {
            try {
                const response = await fetch('/.netlify/functions/get-appwrite-config');
                const config = await response.json();
                
                const sdk = new Appwrite();
                sdk.setEndpoint('https://cloud.appwrite.io/v1')
                   .setProject(config.APPWRITE_PROJECT_ID);
                
                window._lurkoutSDK = sdk;
                window._lurkoutConfig = config;
                
                return sdk;
            } catch (error) {
                console.error('Failed to initialize Appwrite:', error);
                throw error;
            }
        }

        // Checkpoint Management
        let checkpoints = [];
        const checkpointList = document.getElementById('checkpointList');
        const completionUrl = document.getElementById('completionUrl');

        function renderCheckpoints() {
            checkpointList.innerHTML = '';
            checkpoints.forEach((cp, index) => {
                const item = document.createElement('div');
                item.className = `checkpoint-item ${cp.completed ? 'completed' : ''}`;
                item.innerHTML = `
                    <div class="drag-handle">⋮</div>
                    <div class="checkpoint-status">${cp.completed ? '✓' : '○'}</div>
                    <div class="checkpoint-content">
                        <h4 class="checkpoint-title">${cp.title}</h4>
                        <div class="checkpoint-url">${cp.url}</div>
                    </div>
                    <div class="checkpoint-actions">
                        <button class="btn ghost small" onclick="verifyCheckpoint(${index})">Verify</button>
                        <button class="btn ghost small" onclick="deleteCheckpoint(${index})">×</button>
                    </div>
                `;
                checkpointList.appendChild(item);
            });

            // Show completion URL if all checkpoints are completed
            if (checkpoints.length > 0 && checkpoints.every(cp => cp.completed)) {
                generateCompletionUrl();
            } else {
                completionUrl.classList.add('hidden');
            }
        }

        function addCheckpoint() {
            const title = document.getElementById('newCheckpointTitle').value;
            const url = document.getElementById('newCheckpointUrl').value;
            const provider = document.getElementById('newCheckpointProvider').value;

            checkpoints.push({
                title,
                url,
                provider,
                completed: false,
                timestamp: new Date().toISOString()
            });

            closeModal();
            renderCheckpoints();
            saveToAppwrite();
        }

        async function verifyCheckpoint(index) {
            const checkpoint = checkpoints[index];
            try {
                // Verify with provider's API
                const verified = await verifyWithProvider(checkpoint);
                if (verified) {
                    checkpoint.completed = true;
                    checkpoint.completedAt = new Date().toISOString();
                    renderCheckpoints();
                    saveToAppwrite();
                }
            } catch (error) {
                console.error('Verification failed:', error);
            }
        }

        function generateCompletionUrl() {
            const id = generateUniqueId();
            const url = `${window.location.origin}/unlock/${id}`;
            completionUrl.textContent = `Final URL: ${url}`;
            completionUrl.classList.remove('hidden');
            saveCompletionUrl(id, url);
        }

        // Appwrite Integration
        async function saveToAppwrite() {
            try {
                const sdk = window._lurkoutSDK;
                await sdk.database.createDocument(
                    window._lurkoutConfig.COLLECTION_ID,
                    'unique()',
                    {
                        checkpoints,
                        userId: window._lurkoutSession.id
                    }
                );
            } catch (error) {
                console.error('Failed to save to Appwrite:', error);
            }
        }

        async function loadFromAppwrite() {
            try {
                const sdk = window._lurkoutSDK;
                const data = await sdk.database.listDocuments(
                    window._lurkoutConfig.COLLECTION_ID,
                    [
                        Query.equal('userId', window._lurkoutSession.id)
                    ]
                );
                
                if (data.documents.length > 0) {
                    checkpoints = data.documents[0].checkpoints;
                    renderCheckpoints();
                }
            } catch (error) {
                console.error('Failed to load from Appwrite:', error);
            }
        }

        // Auth Logic
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Initialize
        (async function() {
            try {
                await initializeAppwrite();
                
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                
                if (code) {
                    window.history.replaceState({}, '', window.location.pathname);
                    const verifier = localStorage.getItem('code_verifier');
                    if (verifier) {
                        const session = await handleCallback(code, verifier);
                        renderAuth(session);
                        await loadFromAppwrite();
                    }
                } else {
                    const session = JSON.parse(localStorage.getItem('lurkout_session'));
                    if (session) {
                        renderAuth(session);
                        await loadFromAppwrite();
                    }
                }
            } catch (error) {
                console.error('Initialization error:', error);
                localStorage.removeItem('lurkout_session');
                localStorage.removeItem('code_verifier');
                renderAuth(null);
            }
        })();

        // Event Listeners
        document.getElementById('addCheckpoint').onclick = () => {
            document.getElementById('addCheckpointModal').classList.remove('hidden');
        };

        document.getElementById('btnLogin').onclick = async function() {
            const verifier = generateCodeVerifier();
            const challenge = await generateCodeChallenge(verifier);
            
            localStorage.setItem('code_verifier', verifier);
            
            const params = new URLSearchParams({
                client_id: DISCORD_CLIENT_ID,
                redirect_uri: DISCORD_REDIRECT_URI,
                response_type: 'code',
                scope: DISCORD_SCOPE,
                code_challenge: challenge,
                code_challenge_method: 'S256'
            });

            window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        };

        document.getElementById('btnLogout').onclick = function() {
            localStorage.removeItem('lurkout_session');
            localStorage.removeItem('code_verifier');
            renderAuth(null);
        };
    </script>
</body>
</html>