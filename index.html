<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lurkout · Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
    <style>
      :root{--bg:#060608;--panel:#0f1012;--muted:#9aa4b2;--accent:#ff2d55;--glass:rgba(255,255,255,0.03)}
      *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
      body{margin:0;background:linear-gradient(180deg,#050608 0%, #0b0d10 100%);color:#e6eef8;min-height:100vh}
      .wrap{max-width:1100px;margin:28px auto;padding:18px}
      header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
      h1{font-weight:700;letter-spacing:1px}
      .muted{color:var(--muted)}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
      .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:16px;border-radius:12px}
      .btn{background:linear-gradient(90deg,var(--accent),#b91c38);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
      .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
      .row{display:flex;gap:8px}
      input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
      .center{display:flex;align-items:center;justify-content:center}
      .hidden{display:none}
      pre.code{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;max-height:260px;overflow:auto}
      footer{text-align:center;margin-top:18px;color:var(--muted)}
      /* small login card */
      .loginCard{max-width:480px;margin:40px auto;padding:22px;border-radius:14px}
      .logo{display:flex;gap:10px;align-items:center}
      .logo .dot{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#b91c38);box-shadow:0 6px 20px rgba(255,45,85,0.12)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="logo"><div class="dot"></div><h1>Lurkout</h1></div>
        <div id="userArea"></div>
      </header>

      <main id="mainArea">
        <!-- Login screen shown when not authenticated -->
        <section id="loginScreen" class="card loginCard center">
          <div style="width:100%">
            <h2>Sign in to Lurkout</h2>
            <p class="muted">Use Discord to sign in. You will need to attach an email before using the dashboard.</p>
            <div class="row" style="margin-top:12px">
              <button id="btnLogin" class="btn">Sign in with Discord</button>
              <button id="btnHow" class="btn ghost">How it works</button>
            </div>
            <p class="muted small" style="margin-top:12px">Make sure your Appwrite project has Discord OAuth enabled and redirect URL set to this page.</p>
          </div>
        </section>

        <!-- Dashboard: hidden until login -->
        <section id="dashboard" class="hidden">
          <div class="grid">
            <div>
              <div class="card">
                <h3>Account</h3>
                <p id="accountInfo" class="muted">—</p>
                <label class="muted small">Email (attach):<input id="emailInput" placeholder="you@domain.com"></label>
                <div class="row"><button id="attachEmail" class="btn small">Attach email</button><button id="btnLogout" class="btn ghost small">Logout</button></div>
              </div>

              <div class="card" style="margin-top:12px">
                <h3>Checkpoints</h3>
                <label class="muted small">Name: <input id="checkpointName"></label>
                <label class="muted small">Notes: <input id="checkpointNotes"></label>
                <div class="row" style="margin-top:8px"><button id="saveCheckpoint" class="btn small">Save</button><button id="listCheckpoints" class="btn ghost small">Refresh</button></div>
                <ul id="checkpointList" class="muted" style="margin-top:10px;padding-left:0;list-style:none"></ul>
              </div>
            <!doctype html>
            <html lang="en">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width,initial-scale=1" />
                <title>Lurkout · Dashboard</title>
                <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
                <style>
                  :root{--bg:#060608;--panel:#0f1012;--muted:#9aa4b2;--accent:#ff2d55;--glass:rgba(255,255,255,0.03)}
                  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
                  body{margin:0;background:linear-gradient(180deg,#050608 0%, #0b0d10 100%);color:#e6eef8;min-height:100vh}
                  .wrap{max-width:1100px;margin:28px auto;padding:18px}
                  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
                  h1{font-weight:700;letter-spacing:1px}
                  .muted{color:var(--muted)}
                  .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
                  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:16px;border-radius:12px}
                  .btn{background:linear-gradient(90deg,var(--accent),#b91c38);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
                  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
                  .row{display:flex;gap:8px}
                  input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
                  .center{display:flex;align-items:center;justify-content:center}
                  .hidden{display:none}
                  pre.code{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;max-height:260px;overflow:auto}
                  footer{text-align:center;margin-top:18px;color:var(--muted)}
                  .loginCard{max-width:480px;margin:40px auto;padding:22px;border-radius:14px}
                  .logo{display:flex;gap:10px;align-items:center}
                  .logo .dot{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#b91c38);box-shadow:0 6px 20px rgba(255,45,85,0.12)}
                </style>
              </head>
              <body>
                <div class="wrap">
                  <header>
                    <div class="logo"><div class="dot"></div><h1>Lurkout</h1></div>
                    <div id="userArea"></div>
                  </header>

                  <main id="mainArea">
                    <section id="loginScreen" class="card loginCard center">
                      <div style="width:100%">
                        <h2>Sign in to Lurkout</h2>
                        <p class="muted">Use Discord to sign in. The dashboard is only visible after authentication.</p>
                        <div class="row" style="margin-top:12px">
                          <button id="btnLogin" class="btn">Sign in with Discord</button>
                        </div>
                        <p class="muted small" style="margin-top:12px">Redirect URL must be configured in Appwrite and Discord. Deployment injects `config.json` via GitHub Actions from repository secrets.</p>
                      </div>
                    </section>

                    <section id="dashboard" class="hidden">
                      <div class="grid">
                        <div>
                          <div class="card">
                            <h3>Account</h3>
                            <p id="accountInfo" class="muted">—</p>
                            <label class="muted small">Email (attach):<input id="emailInput" placeholder="you@domain.com"></label>
                            <div class="row"><button id="attachEmail" class="btn small">Attach email</button><button id="btnLogout" class="btn ghost small">Logout</button></div>
                          </div>

                          <div class="card" style="margin-top:12px">
                            <h3>Checkpoints</h3>
                            <label class="muted small">Name: <input id="checkpointName"></label>
                            <label class="muted small">Notes: <input id="checkpointNotes"></label>
                            <div class="row" style="margin-top:8px"><button id="saveCheckpoint" class="btn small">Save</button><button id="listCheckpoints" class="btn ghost small">Refresh</button></div>
                            <ul id="checkpointList" class="muted" style="margin-top:10px;padding-left:0;list-style:none"></ul>
                          </div>
                        </div>

                        <div>
                          <div class="card">
                            <h3>Script Generator</h3>
                            <label class="muted small">Script title: <input id="scriptTitle"></label>
                            <label class="muted small">Webhook (optional): <input id="webhookUrl"></label>
                            <div class="row" style="margin-top:8px"><button id="generateScript" class="btn small">Generate .lua</button><button id="downloadLink" class="btn ghost small hidden" download="lurkout.lua">Download</button></div>
                            <pre id="scriptPreview" class="code"></pre>
                          </div>

                          <div class="card" style="margin-top:12px">
                            <h3>Settings</h3>
                            <label class="muted small">Appwrite project: <input id="cfgProject"></label>
                            <label class="muted small">Database ID: <input id="cfgDatabase"></label>
                            <div class="row" style="margin-top:8px"><button id="saveCfg" class="btn small">Save</button><button id="resetCfg" class="btn ghost small">Reset</button></div>
                            <p class="muted small" style="margin-top:8px">Project id prefills for convenience. Database must match your Appwrite collections (users, checkpoints).</p>
                          </div>
                        </div>
                      </div>
                    </section>
                  </main>

                  <footer class="muted">Lurkout · Glassmorphic UI</footer>
                </div>

                <script>
                  // fetch injected config (written by GitHub Actions during deploy)
                  async function loadConfig(){
                    try{
                      const r = await fetch('/config.json', {cache:'no-cache'});
                      if(!r.ok) throw new Error('no config');
                      return await r.json();
                    }catch(e){
                      return JSON.parse(localStorage.getItem('lurkout_cfg')||'{}');
                    }
                  }

                  (async function(){
                    const cfg = await loadConfig();
                    const sdk = new Appwrite();
                    sdk.setEndpoint(cfg.endpoint||'https://cloud.appwrite.io/v1').setProject(cfg.project||'');
                    window._LurkoutAppwrite = {sdk, databaseId: cfg.database||''};

                    // UI refs
                    const loginScreen = document.getElementById('loginScreen');
                    const dashboard = document.getElementById('dashboard');
                    const btnLogin = document.getElementById('btnLogin');
                    const btnLogout = document.getElementById('btnLogout');
                    const userArea = document.getElementById('userArea');
                    const accountInfo = document.getElementById('accountInfo');

                    function renderAuth(user){
                      if(user){
                        loginScreen.classList.add('hidden'); dashboard.classList.remove('hidden');
                        userArea.textContent = user.name || user.$id; accountInfo.textContent = `Signed as ${user.name||user.$id} • ${user.email? 'email attached' : 'no email'}`;
                      } else {
                        loginScreen.classList.remove('hidden'); dashboard.classList.add('hidden'); userArea.textContent=''; accountInfo.textContent='—';
                      }
                    }

                    async function tryGetAccount(){
                      try{ const acc = await sdk.account.get(); const user = {name: acc.name||acc.$id, email: acc.email||null, id: acc.$id}; localStorage.setItem('lurkout_user', JSON.stringify(user)); renderAuth(user); }catch(e){ localStorage.removeItem('lurkout_user'); renderAuth(null); }
                    }

                    btnLogin.onclick = function(){ try{ sdk.account.createOAuth2Session('discord', window.location.href, window.location.href); }catch(e){ console.warn('OAuth redirect', e);} };
                    btnLogout.onclick = function(){ localStorage.removeItem('lurkout_user'); try{ sdk.account.deleteSession('current'); }catch(e){}; renderAuth(null); };

                    // basic checkpoint and script flows are same as demo; omitted for brevity — rely on existing Lua/websync backends for production

                    await tryGetAccount();
                  })();
                </script>
              </body>
            </html>
