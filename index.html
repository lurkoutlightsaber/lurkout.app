<!-- indexxx.txt -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lurkout Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
    <div id="app" class="p-4 flex items-center justify-center min-h-screen"></div>

    <script type="module">
      const { Client, Databases, Query } = Appwrite;

      // --- Configuration ---
      const PROJECT_ID = "6904e9f0002a87c6eb1f";
      const DATABASE_ID = "lurkout-db";
      const USERS_COLLECTION = "users";
      const PLAYERS_COLLECTION = "player_lists";

      // --- Initialize Appwrite ---
      const client = new Client()
        .setEndpoint("https://cloud.appwrite.io/v1")
        .setProject(PROJECT_ID);
      const databases = new Databases(client);

      // --- DOM Reference ---
      const app = document.getElementById("app");

      let state = {
        userKey: localStorage.getItem("lurkout_key") || "",
        isPaired: false,
        username: "",
        playerList: [],
        lastUpdate: null,
        loading: false,
        error: "",
        subscription: null
      };

      function render() {
        if (!state.isPaired) {
          app.innerHTML = `
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-purple-500/20 p-8 w-full max-w-md text-center">
              <div class="inline-block p-3 bg-purple-500/20 rounded-full mb-4">
                <svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              <h1 class="text-3xl font-bold mb-2">Lurkout.app</h1>
              <p class="text-purple-300 mb-6">Enter your loader pairing key</p>
              <input id="pairKey" type="text" placeholder="Enter pairing key..."
                class="w-full px-4 py-3 mb-4 bg-slate-700/50 border border-purple-500/30 rounded-lg text-white text-center"
                value="${state.userKey}"/>
              ${
                state.error
                  ? `<div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-red-400 text-sm mb-4">${state.error}</div>`
                  : ""
              }
              <button id="connectBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-3 rounded-lg font-semibold">
                ${state.loading ? "Connecting..." : "Connect Dashboard"}
              </button>
              <p class="text-xs text-slate-400 mt-6">Get your pairing key from the Lua loader in-game</p>
            </div>
          `;

          const connectBtn = document.getElementById("connectBtn");
          if (connectBtn) {
            connectBtn.onclick = async () => {
              const key = document.getElementById("pairKey").value.trim();
              if (!key) return;
              await verifyPairing(key);
            };
          }
          return;
        }

        // --- Dashboard UI ---
        app.innerHTML = `
          <div class="max-w-6xl w-full mx-auto space-y-6">
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-purple-500/20 p-6 flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <div class="p-3 bg-purple-500/20 rounded-full">
                  <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                </div>
                <div>
                  <h1 class="text-2xl font-bold">Lurkout Dashboard</h1>
                  <p class="text-purple-300 text-sm">Welcome, ${state.username}</p>
                </div>
              </div>
              <button id="disconnectBtn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Disconnect</button>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-purple-500/20 p-6 flex justify-between items-center">
              <div class="flex items-center space-x-3">
                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <span>Connected to Loader</span>
              </div>
              ${
                state.lastUpdate
                  ? `<span class="text-sm text-slate-400">Last update: ${new Date(state.lastUpdate).toLocaleTimeString()}</span>`
                  : ""
              }
            </div>

            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-purple-500/20 p-6">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center">
                  <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                  </svg>
                  Player List
                </h2>
                <span class="text-sm text-purple-400 bg-purple-500/20 px-3 py-1 rounded-full">
                  ${state.playerList.length} players
                </span>
              </div>

              ${
                state.playerList.length === 0
                  ? `<div class="text-center py-12 text-slate-400">
                      <p class="text-lg">Waiting for player data...</p>
                      <p class="text-slate-500 text-sm mt-2">Click "Send Player List" in your loader</p>
                    </div>`
                  : `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                      ${state.playerList
                        .map(
                          (p) => `
                          <div class="bg-slate-700/50 border border-slate-600/30 rounded-lg p-4 hover:bg-slate-700/70 transition-colors">
                            <div class="flex items-center space-x-3">
                              <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-white">
                                ${p.name?.charAt(0)?.toUpperCase() || "?"}
                              </div>
                              <div class="flex-1 min-w-0">
                                <p class="font-medium truncate text-white">${p.name || "Unknown"}</p>
                                ${p.team && p.team !== "None" ? `<p class="text-xs text-slate-400">Team: ${p.team}</p>` : ""}
                              </div>
                            </div>
                          </div>`
                        )
                        .join("")}
                    </div>`
              }
            </div>

            <div class="bg-slate-800/30 rounded-xl border border-slate-700/30 p-4 text-center text-sm text-slate-400">
              Your connection is secure â€¢ Data syncs in real time from your loader
            </div>
          </div>
        `;

        const disconnectBtn = document.getElementById("disconnectBtn");
        if (disconnectBtn) {
          disconnectBtn.onclick = disconnect;
        }
      }

      async function verifyPairing(key) {
        state.loading = true;
        state.error = "";
        render();

        try {
          const res = await databases.listDocuments(DATABASE_ID, USERS_COLLECTION, [
            Query.equal("user_key", key),
            Query.limit(1),
          ]);

          if (res.documents.length > 0) {
            const doc = res.documents[0];
            state.isPaired = true;
            state.username = doc.username || "User";
            state.userKey = key;
            localStorage.setItem("lurkout_key", key);
            await loadPlayerList(key);
            subscribeRealtime(key);
          } else {
            state.error = "Invalid pairing key. Try again.";
          }
        } catch (e) {
          console.error("Pairing error:", e);
          state.error = "Connection failed: " + (e.message || "Unknown error");
        } finally {
          state.loading = false;
          render();
        }
      }

      async function loadPlayerList(key) {
        try {
          const res = await databases.listDocuments(DATABASE_ID, PLAYERS_COLLECTION, [
            Query.equal("user_key", key),
            Query.orderDesc("$createdAt"),
            Query.limit(1),
          ]);

          if (res.documents.length > 0) {
            const doc = res.documents[0];
            const players = JSON.parse(doc.players || "[]");
            state.playerList = players;
            state.lastUpdate = doc.$createdAt;
          }
        } catch (err) {
          console.error("Error loading player list:", err);
        }
      }

      function subscribeRealtime(key) {
        // Unsubscribe previous
        if (state.subscription) {
          state.subscription();
        }

        state.subscription = client.subscribe(
          `databases.${DATABASE_ID}.collections.${PLAYERS_COLLECTION}.documents`,
          (response) => {
            if (response.payload && response.payload.user_key === key) {
              try {
                const players = JSON.parse(response.payload.players || "[]");
                state.playerList = players;
                state.lastUpdate = response.payload.$createdAt || new Date().toISOString();
                render();
              } catch (e) {
                console.error("Failed to parse player data:", e);
              }
            }
          }
        );
      }

      function disconnect() {
        if (state.subscription) {
          state.subscription();
          state.subscription = null;
        }
        localStorage.removeItem("lurkout_key");
        state = {
          ...state,
          isPaired: false,
          userKey: "",
          username: "",
          playerList: [],
          lastUpdate: null,
          loading: false,
          error: "",
          subscription: null
        };
        render();
      }

      // Auto-reconnect on load
      if (state.userKey) {
        verifyPairing(state.userKey);
      } else {
        render();
      }
    </script>
  </body>
</html>