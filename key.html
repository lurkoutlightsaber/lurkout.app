<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LURKOUT LITE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Include all the original styles from index.html */
        /* ... (copy all styles from the original index.html) ... */
        
        /* Add new styles for session key display */
        .session-key-display {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px 20px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            min-width: 300px;
        }
        
        .session-key-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .session-key-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            color: var(--accent-cyan);
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .session-key-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .copy-key-btn {
            background: rgba(6, 255, 165, 0.1);
            border: 1px solid rgba(6, 255, 165, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--accent-cyan);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .copy-key-btn:hover {
            background: rgba(6, 255, 165, 0.2);
        }
        
        .session-instructions {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .session-instructions code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }
    </style>
</head>
<body>
    <!-- All original HTML content -->
    <!-- ... (copy from original index.html) ... -->
    
    <!-- Session Key Display (shown when authenticated) -->
    <div class="session-key-display hidden" id="sessionKeyDisplay">
        <div class="session-key-title">YOUR SESSION KEY</div>
        <div class="session-key-value">
            <span class="session-key-text" id="sessionKeyText">Loading...</span>
            <button class="copy-key-btn" onclick="copySessionKey()">Copy</button>
        </div>
        <div class="session-instructions">
            Enter this key in the Dex Explorer when prompted to sync your game data.
        </div>
    </div>
    
    <script>
        // Original configuration
        const CONFIG = {
            DISCORD_CLIENT_ID: '1432798922757115985',
            REDIRECT_URI: window.location.origin + '/',
            REQUIRED_SERVER_ID: '1431480103686246420',
            REQUIRED_ROLE_ID: '1433579851259838464',
            API_ENDPOINT: 'https://discord.com/api/v10',
            SCOPES: ['identify', 'guilds', 'guilds.members.read'],
            SYNC_POLL_INTERVAL: 2000 // Poll every 2 seconds
        };

        // State
        let state = {
            user: null,
            token: null,
            connected: false,
            sessionStart: Date.now(),
            sessionKey: null,
            syncData: null,
            pollInterval: null
        };
        
        // Generate session key
        function generateSessionKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < 16; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
                if ((i + 1) % 4 === 0 && i < 15) key += '-';
            }
            return key;
        }
        
        // Copy session key to clipboard
        function copySessionKey() {
            const keyText = document.getElementById('sessionKeyText').textContent;
            navigator.clipboard.writeText(keyText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        // Show session key display
        function showSessionKey() {
            if (!state.sessionKey) {
                state.sessionKey = generateSessionKey();
                saveSession(); // Save the key
            }
            
            document.getElementById('sessionKeyText').textContent = state.sessionKey;
            document.getElementById('sessionKeyDisplay').classList.remove('hidden');
            
            addLog('info', 'Session key generated. Use this key in Dex Explorer.');
        }
        
        // Start polling for sync data
        function startSyncPolling() {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
            }
            
            state.pollInterval = setInterval(async () => {
                if (state.sessionKey) {
                    await checkSyncStatus();
                }
            }, CONFIG.SYNC_POLL_INTERVAL);
        }
        
        // Check sync status with backend
        async function checkSyncStatus() {
            try {
                const response = await fetch(`/api/sync/status?key=${state.sessionKey}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.connected !== state.connected) {
                        state.connected = data.connected;
                        updateConnectionStatus();
                        
                        if (data.connected) {
                            addLog('success', `Executor connected: ${data.executor || 'Unknown'}`);
                            document.getElementById('propExecutor').textContent = data.executor || 'Unknown';
                        } else {
                            addLog('warning', 'Executor disconnected');
                        }
                    }
                    
                    // Update tree if new data available
                    if (data.tree && JSON.stringify(data.tree) !== JSON.stringify(state.syncData)) {
                        state.syncData = data.tree;
                        updateGameTree(data.tree);
                        addLog('success', `Game tree updated: ${data.placeName || 'Unknown'}`);
                        document.getElementById('propGame').textContent = data.placeName || 'Connected';
                        document.getElementById('propObjects').textContent = countObjects(data.tree);
                    }
                }
            } catch (error) {
                console.error('[Sync] Status check failed:', error);
            }
        }
        
        // Count objects in tree
        function countObjects(tree) {
            if (!tree) return 0;
            let count = 0;
            
            function countNode(node) {
                count++;
                if (node.Children) {
                    node.Children.forEach(countNode);
                }
            }
            
            tree.forEach(countNode);
            return count;
        }
        
        // Update game tree display
        function updateGameTree(tree) {
            const gameTreeElem = document.getElementById('gameTree');
            if (!gameTreeElem) return;
            
            gameTreeElem.innerHTML = '';
            
            function createTreeItem(node, depth = 0) {
                const item = document.createElement('div');
                item.className = 'tree-item';
                item.style.paddingLeft = (depth * 20) + 'px';
                
                const hasChildren = node.Children && node.Children.length > 0;
                const icon = hasChildren ? 'üìÅ' : 'üìÑ';
                
                item.innerHTML = `<span>${icon}</span> ${node.Name}`;
                item.title = node.ClassName;
                
                item.onclick = () => {
                    // Select item
                    document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
                    item.classList.add('selected');
                    
                    // Update properties panel
                    document.getElementById('propStatus').textContent = state.connected ? 'Connected' : 'Disconnected';
                };
                
                gameTreeElem.appendChild(item);
                
                if (hasChildren && depth < 2) {
                    node.Children.forEach(child => createTreeItem(child, depth + 1));
                }
            }
            
            tree.forEach(node => createTreeItem(node));
        }
        
        // Send command to executor
        async function sendCommand(command) {
            if (!state.sessionKey) {
                addLog('error', 'No session key available');
                return;
            }
            
            try {
                const response = await fetch('/api/commands', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Session-Key': state.sessionKey
                    },
                    body: JSON.stringify({
                        sessionKey: state.sessionKey,
                        command: command
                    })
                });
                
                if (response.ok) {
                    addLog('info', `Command sent: ${command.type}`);
                } else {
                    addLog('error', 'Failed to send command');
                }
            } catch (error) {
                console.error('[Command] Failed to send:', error);
                addLog('error', 'Failed to send command: ' + error.message);
            }
        }
        
        // Modified explorer actions to send commands
        function connectExecutor() {
            if (!state.sessionKey) {
                showSessionKey();
            }
            
            addLog('info', 'Waiting for executor connection...');
            addLog('warning', 'Make sure to enter the session key in Dex Explorer');
            addLog('info', 'Connection instructions:');
            addLog('info', '1. Execute the LURKOUT LITE Dex script in your executor');
            addLog('info', '2. Enter your session key when prompted');
            addLog('info', '3. The connection will be established automatically');
            
            startSyncPolling();
        }
        
        function scanGame() {
            if (!state.connected) {
                addLog('error', 'Please connect executor first');
                return;
            }
            
            addLog('info', 'Requesting game scan...');
            sendCommand({ type: 'scan_game' });
        }
        
        function refreshTree() {
            if (!state.connected) {
                addLog('error', 'Please connect executor first');
                return;
            }
            
            addLog('info', 'Refreshing game tree...');
            sendCommand({ type: 'refresh_tree' });
        }
        
        // Modified session management to include session key
        function saveSession() {
            const session = {
                user: state.user,
                token: state.token,
                sessionKey: state.sessionKey,
                timestamp: Date.now()
            };
            localStorage.setItem('lurkout_lite_session', JSON.stringify(session));
        }
        
        function loadSession() {
            try {
                const stored = localStorage.getItem('lurkout_lite_session');
                if (!stored) return null;

                const session = JSON.parse(stored);
                const age = Date.now() - session.timestamp;
                
                if (age > 7 * 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('lurkout_lite_session');
                    return null;
                }

                return session;
            } catch (error) {
                console.error('[Session] Load error:', error);
                return null;
            }
        }
        
        // Modified showExplorerApp to show session key
        function showExplorerApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('explorerApp').classList.remove('hidden');
            updateUserSection();
            startSessionTimer();
            showSessionKey();
            startSyncPolling();
            addLog('success', 'Access granted! Explorer ready.');
            addLog('info', 'Click "Connect Executor" to start syncing with your game');
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
            }
        });
        
        // ... (include all other original functions from index.html) ...
        
    </script>
</body>
</html>